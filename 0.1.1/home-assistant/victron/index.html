<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Home automation with the power of the sun"><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.1, mkdocs-material-8.5.7"><title>Victron Energy - Project Ra</title><link rel=stylesheet href=../../assets/stylesheets/main.20d9efc8.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.cbb835fc.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CHackman:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Hackman"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=orange data-md-color-accent=orange> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#victron-energy class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-component=outdated hidden> <aside class="md-banner md-banner--warning"> <div class="md-banner__inner md-grid md-typeset"> You're not viewing the latest version. <a href=../../..> <strong>Click here to go to latest.</strong> </a> </div> <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script> </aside> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Project Ra" class="md-header__button md-logo" aria-label="Project Ra" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Project Ra </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Victron Energy </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=orange data-md-color-accent=orange aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=orange data-md-color-accent=orange aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/darth-veitcher/project-ra title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> darth-veitcher/project-ra </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Project Ra </a> </li> <li class=md-tabs__item> <a href=../../lessons-learned/ class=md-tabs__link> Lessons Learned </a> </li> <li class=md-tabs__item> <a href=../../getting-started/pre-reqs/ class="md-tabs__link md-tabs__link--active"> Getting Started </a> </li> <li class=md-tabs__item> <a href=../../todo/ class=md-tabs__link> Roadmap </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Project Ra" class="md-nav__button md-logo" aria-label="Project Ra" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </a> Project Ra </label> <div class=md-nav__source> <a href=https://github.com/darth-veitcher/project-ra title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> darth-veitcher/project-ra </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Project Ra </a> </li> <li class=md-nav__item> <a href=../../lessons-learned/ class=md-nav__link> Lessons Learned </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3> Getting Started <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Getting Started" data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../getting-started/pre-reqs/ class=md-nav__link> Pre Reqs </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Victron Energy <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Victron Energy </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#victron-energy class=md-nav__link> Victron Energy </a> <nav class=md-nav aria-label="Victron Energy"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#enable-modbus-tcp class=md-nav__link> Enable Modbus TCP </a> </li> <li class=md-nav__item> <a href=#modbus-device-basic-concepts class=md-nav__link> Modbus Device Basic Concepts </a> <nav class=md-nav aria-label="Modbus Device Basic Concepts"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#reading-values class=md-nav__link> Reading Values </a> </li> <li class=md-nav__item> <a href=#writing-values class=md-nav__link> Writing Values </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#home-assistant class=md-nav__link> Home Assistant </a> <nav class=md-nav aria-label="Home Assistant"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#modbus-extension-configurationyaml class=md-nav__link> Modbus extension: configuration.yaml </a> </li> <li class=md-nav__item> <a href=#services-modbusyaml class=md-nav__link> Services: modbus.yaml </a> </li> <li class=md-nav__item> <a href=#templates-sensorsensor_modbusyaml class=md-nav__link> Templates: sensor/sensor_modbus.yaml </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#sources class=md-nav__link> Sources </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../todo/ class=md-nav__link> Roadmap </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#victron-energy class=md-nav__link> Victron Energy </a> <nav class=md-nav aria-label="Victron Energy"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#enable-modbus-tcp class=md-nav__link> Enable Modbus TCP </a> </li> <li class=md-nav__item> <a href=#modbus-device-basic-concepts class=md-nav__link> Modbus Device Basic Concepts </a> <nav class=md-nav aria-label="Modbus Device Basic Concepts"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#reading-values class=md-nav__link> Reading Values </a> </li> <li class=md-nav__item> <a href=#writing-values class=md-nav__link> Writing Values </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#home-assistant class=md-nav__link> Home Assistant </a> <nav class=md-nav aria-label="Home Assistant"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#modbus-extension-configurationyaml class=md-nav__link> Modbus extension: configuration.yaml </a> </li> <li class=md-nav__item> <a href=#services-modbusyaml class=md-nav__link> Services: modbus.yaml </a> </li> <li class=md-nav__item> <a href=#templates-sensorsensor_modbusyaml class=md-nav__link> Templates: sensor/sensor_modbus.yaml </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#sources class=md-nav__link> Sources </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/darth-veitcher/project-ra/edit/master/docs/home-assistant/victron.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1>Victron Energy</h1> <h3 id=victron-energy>Victron Energy<a class=headerlink href=#victron-energy title="Permanent link">&para;</a></h3> <p>This section describes how to add Victron Energy devices into Home Assistant.</p> <h4 id=enable-modbus-tcp>Enable Modbus TCP<a class=headerlink href=#enable-modbus-tcp title="Permanent link">&para;</a></h4> <p>Go to the <code>remote console</code> for the Cerbo GX device and ensure Modbus is enabled (it's disabled by default).</p> <p>Settings &gt;&gt; Services &gt;&gt; Modbus TCP &gt;&gt; Select <code>Enabled</code></p> <p>Next click into the <code>Available services</code> section of this menu and you should see a list of entries with familiar looking descriptions to your victron devices such as <code>SmartShunt</code> and associated <code>Unit ID</code> values (which we will require for identifying them later on).</p> <p><img alt="remote console" src=../../assets/remote-console-modbus-services.png></p> <p>In my setup I have the following: <strong>Note: This is likely where your setup will have different values.</strong></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>ID</th> </tr> </thead> <tbody> <tr> <td>SmartShunt 500A/50mV</td> <td>battery</td> <td>224</td> </tr> <tr> <td>SmartSolar MPPT 150/100</td> <td>solarcharger</td> <td>100</td> </tr> <tr> <td>(no entry name)</td> <td>system</td> <td>100</td> </tr> <tr> <td>Phoenix Inverter Compact 24/1600</td> <td>vebus</td> <td>227</td> </tr> <tr> <td>Skylla-i 24/80A (1+1)</td> <td>charger</td> <td>100</td> </tr> </tbody> </table> <p>As can be seen from the above there is a generic, unnamed <code>com.victron.system</code> type device in the list with a <code>Unit ID</code> of <code>100</code>. This is the Cerbo GX device. The <code>IDs</code> have been stored inside the <code>secrets.yaml</code> configuration file as follows:</p> <div class=highlight><span class=filename>YAML</span><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=c1># file: secrets.yaml</span><span class=w></span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=c1># victron `Unit IDs` from Modbus settings</span><span class=w></span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=nt>com.victronenergy.system</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">100</span><span class=w></span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=nt>com.victronenergy.battery</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">224</span><span class=w></span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=nt>com.victronenergy.vebus</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">227</span><span class=w></span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=nt>com.victronenergy.solarcharger</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">100</span><span class=w></span>
</code></pre></div> <h4 id=modbus-device-basic-concepts>Modbus Device Basic Concepts<a class=headerlink href=#modbus-device-basic-concepts title="Permanent link">&para;</a></h4> <h5 id=reading-values>Reading Values<a class=headerlink href=#reading-values title="Permanent link">&para;</a></h5> <p>This is explained in far more detail elsewhere, including in the <a href=https://www.victronenergy.com/live/ccgx:modbustcp_faq>Victron Energy: GC Modbus-TCP Manual</a>, but in order to effectively utilise modbus devices we need to know both the <code>Unit ID</code> of the physical hardware and then the associated <code>register address</code> for the sensor/switch that we'd like to read/write. Whilst you can find the <code>Unit ID</code> above, the specifics for the <code>registers</code> have to be found from the manufacturers specification. In the instance of Victron they publish theirs in an Excel file that you need to download from their website. The version I am using is <code>CCGX-Modbus-TCP-register-list-2.90</code> which can be found <a href=https://www.victronenergy.com/support-and-downloads/technical-information>here</a>. It'll contain information similar to the below.</p> <p><img alt="modbus fieldlist" src=../../assets/modbus-field-list.png></p> <table> <thead> <tr> <th>dbus-service-name</th> <th>description</th> <th>Address</th> <th>Type</th> <th>Scalefactor</th> <th>Range</th> <th>dbus-obj-path</th> <th>writable</th> <th>dbus-unit</th> </tr> </thead> <tbody> <tr> <td>com.victronenergy.system</td> <td>Battery Voltage (System)</td> <td>840</td> <td>uint16</td> <td>10</td> <td>0 to 6553.5</td> <td>/Dc/Battery/Voltage</td> <td>no</td> <td>V DC</td> </tr> <tr> <td>com.victronenergy.system</td> <td>Battery Current (System)</td> <td>841</td> <td>int16</td> <td>10</td> <td>-3276.8 to 3276.7</td> <td>/Dc/Battery/Current</td> <td>no</td> <td>A DC</td> </tr> <tr> <td>com.victronenergy.system</td> <td>Battery Power (System)</td> <td>842</td> <td>int16</td> <td>1</td> <td>-32768 to 32767</td> <td>/Dc/Battery/Power</td> <td>no</td> <td>W</td> </tr> <tr> <td>com.victronenergy.system</td> <td>Battery State of Charge (System)</td> <td>843</td> <td>uint16</td> <td>1</td> <td>0 to 100</td> <td>/Dc/Battery/Soc</td> <td>no</td> <td>%</td> </tr> <tr> <td>com.victronenergy.system</td> <td>Battery state (System)</td> <td>844</td> <td>uint16</td> <td>1</td> <td>0 to 65536</td> <td>/Dc/Battery/State</td> <td>no</td> <td>0=idle;1=charging;2=discharging</td> </tr> <tr> <td>com.victronenergy.system</td> <td>Battery Consumed Amphours (System)</td> <td>845</td> <td>uint16</td> <td>-10</td> <td>0 to -6553.6</td> <td>/Dc/Battery/ConsumedAmphours</td> <td>no</td> <td>Ah</td> </tr> </tbody> </table> <p>As a result, using the above information, if we wanted to read the <code>Battery state</code> from the <code>system</code> (as opposed to the smart shunt) we would need to construct a sensor inside Home Assistant that targets slave <code>100</code> and address <code>844</code>. This would provide us with an unsigned integer of 0, 1 or 2 as possible return values indicating the state of the battery (idle, charging, discharging).</p> <p>We can test this out quickly using raw python.</p> <div class=highlight><span class=filename>Bash</span><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1># create a virtual environment</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>python -m venv env
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=nb>source</span> env/venv/activate
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=c1># install pymodbus</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>pip install --upgrade pip <span class=s1>&#39;pymodbus[serial]&#39;</span>
</code></pre></div> <p>Inside the python interpreter.</p> <div class=highlight><span class=filename>Python</span><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=kn>from</span> <span class=nn>pymodbus.client</span> <span class=kn>import</span> <span class=n>ModbusTcpClient</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=n>client</span> <span class=o>=</span> <span class=n>ModbusTcpClient</span><span class=p>(</span><span class=s1>&#39;einstein.local&#39;</span><span class=p>)</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>read_holding_registers</span><span class=p>(</span><span class=mi>844</span><span class=p>,</span> <span class=n>slave</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>registers</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>  <span class=c1># first item in the register</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=n>client</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</code></pre></div> <h5 id=writing-values>Writing Values<a class=headerlink href=#writing-values title="Permanent link">&para;</a></h5> <p>In order to control modbus devices we can write to them. As we saw from the above table however all of the services in question had <code>no</code> in the <code>writable</code> column. We'll instead attempt to toggle the inverter on and off. This was on the <code>vebus</code> connection and the service in question we want is the <code>Switch Position</code></p> <table> <thead> <tr> <th>dbus-service-name</th> <th>description</th> <th>Address</th> <th>Type</th> <th>Scalefactor</th> <th>Range</th> <th>dbus-obj-path</th> <th>writable</th> <th>dbus-unit</th> </tr> </thead> <tbody> <tr> <td>com.victronenergy.vebus</td> <td>Switch Position</td> <td>33</td> <td>uint16</td> <td>1</td> <td>0 to 65536</td> <td>/Mode</td> <td>yes</td> <td>1=Charger Only;2=Inverter Only;3=On;4=Off</td> </tr> </tbody> </table> <p>Setting the value to anything between <code>1</code> and <code>4</code> on the address <code>33</code> for slave <code>227</code> will therefore modify the state of the inverter accordingly.</p> <p>We can test this out quickly using raw python inside the same python interpreter from previous read steps.</p> <div class=highlight><span class=filename>Python</span><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=kn>from</span> <span class=nn>pymodbus.client</span> <span class=kn>import</span> <span class=n>ModbusTcpClient</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=n>client</span> <span class=o>=</span> <span class=n>ModbusTcpClient</span><span class=p>(</span><span class=s1>&#39;einstein.local&#39;</span><span class=p>)</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=c1># find current state</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>read_holding_registers</span><span class=p>(</span><span class=mi>33</span><span class=p>,</span> <span class=n>slave</span><span class=o>=</span><span class=mi>227</span><span class=p>)</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>registers</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>  <span class=c1># first item in the register</span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=c1># set new value to 4 (off)</span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=n>client</span><span class=o>.</span><span class=n>write_registers</span><span class=p>(</span><span class=mi>33</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=n>slave</span><span class=o>=</span><span class=mi>227</span><span class=p>)</span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=n>client</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</code></pre></div> <h4 id=home-assistant>Home Assistant<a class=headerlink href=#home-assistant title="Permanent link">&para;</a></h4> <p>In order to integrate our above ModbusTCP understanding into Home Assistant we need to perform a few steps:</p> <ol> <li>Enable the <code>Modbus</code> extension - inside the <code>configuration.yaml</code>;</li> <li>Provide this extension with a list of available services and how to interpret them - inside the <code>modbus.yaml</code>; and</li> <li>Explain how to translate the returned enums into human readable responses - inside the <code>sensor/modbus_sensor.yaml</code> file.</li> </ol> <h5 id=modbus-extension-configurationyaml>Modbus extension: <code>configuration.yaml</code><a class=headerlink href=#modbus-extension-configurationyaml title="Permanent link">&para;</a></h5> <p>Home Assistant comes with an inbuilt extension to support the Modbus protocol. Full documentation can be found <a href=https://www.home-assistant.io/integrations/modbus>here</a>. The extension needs to be enabled within the <code>configuration.yaml</code> file however as opposed to being added via the UI.</p> <div class=highlight><span class=filename>configuration.yaml</span><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=nt>modbus</span><span class=p>:</span><span class=w> </span><span class=kt>!include</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">modbus.yaml</span><span class=w></span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=c1># Includes all Templates / Sensors in folder sensor</span><span class=w></span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=nt>sensor</span><span class=p>:</span><span class=w> </span><span class=kt>!include_dir_merge_list</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">sensor/</span><span class=w></span>
</code></pre></div> <p>We're going to follow a separation of concerns and keep our modbus service configuration in a separate file called <code>modbus.yaml</code>. Our templates (for displaying enums) will be within a dedicated <code>sensor/sensor_modbus.yaml</code> file. The folder structure will therefore look as follows:</p> <div class=highlight><span class=filename>Bash</span><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>config
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>├── configuration.yaml
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>├── modbus.yaml
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>├── secrets.yaml
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>└── sensor
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>    └── sensor_modbus.yaml
</code></pre></div> <h5 id=services-modbusyaml>Services: <code>modbus.yaml</code><a class=headerlink href=#services-modbusyaml title="Permanent link">&para;</a></h5> <p>The <code>modbus.yaml</code> file configures the extension with the known endpoints for our Cerbo GX, the connected devices, and their capabilities (published as services). An example is given below, simply add additional entries into the <code>sensors</code> section the mapping of yaml to the spreadsheet above should be fairly obvious, with the exception of the <code>scale</code> (needs to be <code>1 / [scalefactor]</code>) and <code>precision</code> (how accurate the value is in decimal places).</p> <div class=highlight><span class=filename>modbus.yaml</span><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;victron&quot;</span><span class=w></span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">tcp</span><span class=w></span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>  </span><span class=nt>delay</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span><span class=w></span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>  </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span><span class=w></span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=kt>!secret</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cerbo_ip</span><span class=w></span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">502</span><span class=w></span>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=w>  </span><span class=nt>sensors</span><span class=p>:</span><span class=w></span>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Battery</span><span class=nv> </span><span class=s>Voltage</span><span class=nv> </span><span class=s>(System)&quot;</span><span class=w></span>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>      </span><span class=c1># Battery Voltage determined from different measurements. In order of preference: BMV-voltage (V), Multi-DC-Voltage (CV), MPPT-DC-Voltage (ScV), Charger voltage</span><span class=w></span>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=w>      </span><span class=nt>scan_interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class=w></span>
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=w>      </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">840</span><span class=w></span>
<a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=w>      </span><span class=nt>slave</span><span class=p>:</span><span class=w> </span><span class=kt>!secret</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">com.victronenergy.system</span><span class=w></span>
<a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=w>      </span><span class=nt>data_type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">uint16</span><span class=w></span>
<a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=w>      </span><span class=nt>unit_of_measurement</span><span class=p>:</span><span class=w> </span><span class=s>&quot;V</span><span class=nv> </span><span class=s>DC&quot;</span><span class=w></span>
<a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=w>      </span><span class=nt>device_class</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">voltage</span><span class=w></span>
<a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=w>      </span><span class=nt>scale</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span><span class=w></span>
<a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=w>      </span><span class=nt>precision</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class=w></span>
<a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Battery</span><span class=nv> </span><span class=s>Current</span><span class=nv> </span><span class=s>(System)&quot;</span><span class=w></span>
<a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a><span class=w>      </span><span class=c1># Postive: battery begin charged. Negative: battery being discharged</span><span class=w></span>
<a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=w>      </span><span class=nt>scan_interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class=w></span>
<a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=w>      </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">841</span><span class=w></span>
<a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a><span class=w>      </span><span class=nt>slave</span><span class=p>:</span><span class=w> </span><span class=kt>!secret</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">com.victronenergy.system</span><span class=w></span>
<a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a><span class=w>      </span><span class=nt>data_type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">int16</span><span class=w></span>
<a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a><span class=w>      </span><span class=nt>unit_of_measurement</span><span class=p>:</span><span class=w> </span><span class=s>&quot;A</span><span class=nv> </span><span class=s>DC&quot;</span><span class=w></span>
<a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a><span class=w>      </span><span class=nt>device_class</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">current</span><span class=w></span>
<a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a><span class=w>      </span><span class=nt>scale</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span><span class=w></span>
<a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a><span class=w>      </span><span class=nt>precision</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class=w></span>
<a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Battery</span><span class=nv> </span><span class=s>Power</span><span class=nv> </span><span class=s>(System)&quot;</span><span class=w></span>
<a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a><span class=w>      </span><span class=c1># Postive: battery begin charged. Negative: battery being discharged</span><span class=w></span>
<a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a><span class=w>      </span><span class=nt>scan_interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class=w></span>
<a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a><span class=w>      </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">842</span><span class=w></span>
<a id=__codelineno-6-32 name=__codelineno-6-32 href=#__codelineno-6-32></a><span class=w>      </span><span class=nt>slave</span><span class=p>:</span><span class=w> </span><span class=kt>!secret</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">com.victronenergy.system</span><span class=w></span>
<a id=__codelineno-6-33 name=__codelineno-6-33 href=#__codelineno-6-33></a><span class=w>      </span><span class=nt>data_type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">int16</span><span class=w></span>
<a id=__codelineno-6-34 name=__codelineno-6-34 href=#__codelineno-6-34></a><span class=w>      </span><span class=nt>unit_of_measurement</span><span class=p>:</span><span class=w> </span><span class=s>&quot;W&quot;</span><span class=w></span>
<a id=__codelineno-6-35 name=__codelineno-6-35 href=#__codelineno-6-35></a><span class=w>      </span><span class=nt>device_class</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">energy</span><span class=w></span>
<a id=__codelineno-6-36 name=__codelineno-6-36 href=#__codelineno-6-36></a><span class=w>      </span><span class=nt>scale</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class=w></span>
<a id=__codelineno-6-37 name=__codelineno-6-37 href=#__codelineno-6-37></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Battery</span><span class=nv> </span><span class=s>State</span><span class=nv> </span><span class=s>of</span><span class=nv> </span><span class=s>Charge</span><span class=nv> </span><span class=s>(System)&quot;</span><span class=w></span>
<a id=__codelineno-6-38 name=__codelineno-6-38 href=#__codelineno-6-38></a><span class=w>      </span><span class=c1># Best battery state of charge, determined from different measurements.</span><span class=w></span>
<a id=__codelineno-6-39 name=__codelineno-6-39 href=#__codelineno-6-39></a><span class=w>      </span><span class=nt>scan_interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class=w></span>
<a id=__codelineno-6-40 name=__codelineno-6-40 href=#__codelineno-6-40></a><span class=w>      </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">843</span><span class=w></span>
<a id=__codelineno-6-41 name=__codelineno-6-41 href=#__codelineno-6-41></a><span class=w>      </span><span class=nt>slave</span><span class=p>:</span><span class=w> </span><span class=kt>!secret</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">com.victronenergy.system</span><span class=w></span>
<a id=__codelineno-6-42 name=__codelineno-6-42 href=#__codelineno-6-42></a><span class=w>      </span><span class=nt>data_type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">uint16</span><span class=w></span>
<a id=__codelineno-6-43 name=__codelineno-6-43 href=#__codelineno-6-43></a><span class=w>      </span><span class=nt>unit_of_measurement</span><span class=p>:</span><span class=w> </span><span class=s>&quot;%&quot;</span><span class=w></span>
<a id=__codelineno-6-44 name=__codelineno-6-44 href=#__codelineno-6-44></a><span class=w>      </span><span class=nt>device_class</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">battery</span><span class=w></span>
<a id=__codelineno-6-45 name=__codelineno-6-45 href=#__codelineno-6-45></a><span class=w>      </span><span class=nt>scale</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class=w></span>
<a id=__codelineno-6-46 name=__codelineno-6-46 href=#__codelineno-6-46></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Battery</span><span class=nv> </span><span class=s>state</span><span class=nv> </span><span class=s>(System)&quot;</span><span class=w></span>
<a id=__codelineno-6-47 name=__codelineno-6-47 href=#__codelineno-6-47></a><span class=w>      </span><span class=c1># 0=idle;1=charging;2=discharging</span><span class=w></span>
<a id=__codelineno-6-48 name=__codelineno-6-48 href=#__codelineno-6-48></a><span class=w>      </span><span class=nt>scan_interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class=w></span>
<a id=__codelineno-6-49 name=__codelineno-6-49 href=#__codelineno-6-49></a><span class=w>      </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">844</span><span class=w></span>
<a id=__codelineno-6-50 name=__codelineno-6-50 href=#__codelineno-6-50></a><span class=w>      </span><span class=nt>slave</span><span class=p>:</span><span class=w> </span><span class=kt>!secret</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">com.victronenergy.system</span><span class=w></span>
<a id=__codelineno-6-51 name=__codelineno-6-51 href=#__codelineno-6-51></a><span class=w>      </span><span class=nt>data_type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">int16</span><span class=w></span>
<a id=__codelineno-6-52 name=__codelineno-6-52 href=#__codelineno-6-52></a><span class=w>      </span><span class=nt>device_class</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">battery</span><span class=w></span>
<a id=__codelineno-6-53 name=__codelineno-6-53 href=#__codelineno-6-53></a><span class=w>      </span><span class=nt>scale</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class=w></span>
</code></pre></div> <h5 id=templates-sensorsensor_modbusyaml>Templates: <code>sensor/sensor_modbus.yaml</code><a class=headerlink href=#templates-sensorsensor_modbusyaml title="Permanent link">&para;</a></h5> <p>This has to be done in hideous yaml unfortunately using jinja2 syntax... We use <code>if</code> <code>then</code> <code>else</code> type flows in order to return the correct human readable representation of the enum.</p> <p><strong>NB:</strong> Note how we are referencing <code>battery_state_system</code> as the root sensor. Home Assistant will automatically escape the human readable "Battery state (System)" description given to it in our <code>modbus.yaml</code> file originally.</p> <div class=highlight><span class=filename>sensor/sensor_modbus.yaml</span><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">template</span><span class=w></span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=w>  </span><span class=nt>sensors</span><span class=p>:</span><span class=w></span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>    </span><span class=nt>battery_state_system_friendly</span><span class=p>:</span><span class=w></span>
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=w>      </span><span class=nt>friendly_name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Battery</span><span class=nv> </span><span class=s>State</span><span class=nv> </span><span class=s>(System)&quot;</span><span class=w></span>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=w>      </span><span class=c1># 0=idle;1=charging;2=discharging</span><span class=w></span>
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=w>      </span><span class=nt>value_template</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">&gt;-</span><span class=w></span>
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=w>        </span><span class=no>{% if (states(&#39;sensor.battery_state_system&#39;) | int(default=0) == 0) %}</span><span class=w></span>
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=w>          </span><span class=no>Idle</span><span class=w></span>
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=w>        </span><span class=no>{% elif (states(&#39;sensor.battery_state_system&#39;) | int(default=0) == 1) %}</span><span class=w></span>
<a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=w>          </span><span class=no>Charging</span><span class=w></span>
<a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=w>        </span><span class=no>{% elif (states(&#39;sensor.battery_state_system&#39;) | int(default=0) == 2) %}</span><span class=w></span>
<a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=w>          </span><span class=no>Discharging</span><span class=w></span>
<a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=w>        </span><span class=no>{% else %}</span><span class=w></span>
<a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a><span class=w>          </span><span class=no>ERROR</span><span class=w></span>
<a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a><span class=w>        </span><span class=no>{% endif %}</span><span class=w></span>
</code></pre></div> <p>You should now be able to create a card within Home Assistant that contains the details and history for the system battery.</p> <p><img alt="basic ui card" src=../../assets/example-lovelace-card-read-battery.png></p> <h4 id=sources>Sources<a class=headerlink href=#sources title="Permanent link">&para;</a></h4> <p>Thanks to the following for resources used in this process of learning:</p> <ul> <li><a href=https://community.victronenergy.com/questions/78971/home-assistant-modbus-integration-tutorial.html>Victron Energy Forums: HA Modbus Integration Tutorial</a></li> <li><a href=https://github.com/lucode/home-assistant>lucode/home-assistant</a></li> <li><a href=https://www.home-assistant.io/integrations/modbus>Home Assistant: Modbus</a></li> <li><a href=https://www.victronenergy.com/live/ccgx:modbustcp_faq>Victron Energy: GC Modbus-TCP Manual</a></li> </ul> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../getting-started/pre-reqs/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Pre Reqs" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Pre Reqs </div> </div> </a> <a href=../../todo/ class="md-footer__link md-footer__link--next" aria-label="Next: Roadmap" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Roadmap </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; Darth Veitcher </div> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.top"], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"default": "stable", "provider": "mike"}}</script> <script src=../../assets/javascripts/bundle.8492ddcf.min.js></script> </body> </html>